<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BewerbungsWerk – Vermieteransicht</title>

  <style>
    :root{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color-scheme: light;

      --bg: #f4f7fb;
      --card: #ffffff;
      --text: #0f172a;
      --muted: #64748b;

      --brand: #1f6feb;
      --brand2: #00b894;

      --shadow: 0 12px 30px rgba(2,6,23,.08);
      --shadowSoft: 0 6px 18px rgba(2,6,23,.06);
      --radius: 18px;
      --border: rgba(15, 23, 42, .10);

      --okBg: #e8f7ee;
      --okFg: #0b6b2f;

      --badBg: #fdecec;
      --badFg: #8a1414;

      --warnBg: #fff7e6;
      --warnFg: #7a4b00;

      --pillBg: #f1f5f9;
      --pillFg: #334155;

      --btnBg: #0f172a;
      --btnFg: #ffffff;
      --btnHover: #142043;

      --chipBg: #eef2f6;
      --chipFg: #111827;

      --greenBg: #e7f7ef;
      --greenFg: #0b6b2f;
      --greenBorder: rgba(11,107,47,.18);
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      background: radial-gradient(1200px 600px at 20% -10%, rgba(31,111,235,.12), transparent 60%),
                  radial-gradient(900px 500px at 90% 0%, rgba(0,184,148,.10), transparent 55%),
                  var(--bg);
      color: var(--text);
      padding: 18px;
    }

    .wrap{ max-width: 980px; margin: 0 auto; }

    .card{
      background: var(--card);
      border-radius: var(--radius);
      padding: 18px;
      box-shadow: var(--shadow);
      border: 1px solid rgba(15,23,42,.06);
      margin-bottom: 14px;
    }

    /* Header */
    .header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      flex-wrap: wrap;
    }

    .brand{
      display:flex;
      align-items:center;
      gap: 12px;
      min-width: 260px;
    }

    .logo{
      width: 44px;
      height: 44px;
      border-radius: 12px;
      background: linear-gradient(135deg, var(--brand), var(--brand2));
      box-shadow: 0 10px 20px rgba(31,111,235,.18);
      display:grid;
      place-items:center;
      flex: 0 0 auto;
    }

    .logo svg{ width: 26px; height: 26px; color: #fff; }

    .brand h1{
      margin: 0;
      font-size: 26px;
      font-weight: 1000;
      letter-spacing: -0.03em;
      line-height: 1.1;
    }
    .brand .sub{
      margin-top: 5px;
      font-size: 13px;
      font-weight: 650;
      color: var(--muted);
    }

    .pillTag{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding: 10px 14px;
      border-radius: 999px;
      font-weight: 950;
      letter-spacing: .01em;
      border: 1px solid var(--greenBorder);
      background: linear-gradient(180deg, rgba(0,184,148,.18), rgba(0,184,148,.10));
      color: #0b6b2f;
      white-space: nowrap;
    }

    /* Status row */
    .statusGrid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap: 12px;
      margin-top: 14px;
    }

    @media (max-width: 820px){
      .statusGrid{ grid-template-columns: 1fr; }
      .brand{ min-width: 0; }
    }

    .statusCard{
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 14px;
      background: linear-gradient(180deg, rgba(15,23,42,.02), transparent 55%);
    }

    .row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      flex-wrap: wrap;
    }

    .badge{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 999px;
      font-weight: 950;
      font-size: 13px;
      background: var(--chipBg);
      color: var(--chipFg);
      border: 1px solid rgba(15,23,42,.08);
      white-space: nowrap;
    }
    .ok{ background: var(--okBg); color: var(--okFg); border-color: rgba(11,107,47,.18); }
    .bad{ background: var(--badBg); color: var(--badFg); border-color: rgba(138,20,20,.18); }

    .kpis{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
      margin-top: 12px;
    }
    @media (max-width: 520px){
      .kpis{ grid-template-columns: 1fr; }
    }

    .kpi{
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 10px 12px;
      background: #fff;
    }
    .kpi .label{ font-size: 12px; color: var(--muted); margin-bottom: 4px; }
    .kpi .value{ font-size: 15px; font-weight: 950; }

    .hintLine{
      font-size: 14px;
      font-weight: 750;
      color: var(--muted);
      padding: 4px 2px 0;
    }

    .warn{
      background: var(--warnBg);
      color: var(--warnFg);
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid rgba(122,75,0,.18);
      margin-top: 12px;
      display:none;
    }

    /* Documents */
    .docsHeader{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .docsTitle{
      display:flex;
      align-items:center;
      gap: 10px;
      font-size: 18px;
      font-weight: 1000;
      letter-spacing: -.01em;
    }
    .docsTitle svg{ width: 20px; height: 20px; color: var(--brand); }

    .docsCount{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 999px;
      background: rgba(31,111,235,.08);
      border: 1px solid rgba(31,111,235,.18);
      color: #12458f;
      font-weight: 950;
      font-size: 13px;
      white-space: nowrap;
    }

    .docsGrid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
      margin-top: 14px;
    }
    @media (min-width: 760px){
      .docsGrid{ grid-template-columns: 1fr 1fr; }
    }

    .docCard{
      display:flex;
      gap: 14px;
      align-items:flex-start;
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 14px;
      background: #fff;
      box-shadow: var(--shadowSoft);
      transition: transform .15s ease, box-shadow .15s ease;
    }
    .docCard:hover{
      transform: translateY(-2px);
      box-shadow: 0 14px 34px rgba(2,6,23,.10);
    }

    .docIcon{
      width: 54px;
      height: 54px;
      border-radius: 16px;
      display:grid;
      place-items:center;
      flex: 0 0 auto;
      border: 1px solid rgba(15,23,42,.08);
      background: linear-gradient(180deg, rgba(31,111,235,.10), rgba(0,184,148,.08));
    }
    .docIcon svg{ width: 28px; height: 28px; color: #0f172a; opacity: .92; }

    .docMain{ flex: 1 1 auto; min-width: 0; }
    .docName{
      font-size: 16px;
      font-weight: 1000;
      margin: 0 0 6px 0;
      letter-spacing: -.01em;
      line-height: 1.2;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .docMeta{
      display:flex;
      align-items:center;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      padding: 4px 10px;
      border-radius: 999px;
      background: var(--pillBg);
      color: var(--pillFg);
      border: 1px solid rgba(51,65,85,.10);
      font-size: 12px;
      font-weight: 950;
    }
    .docId{
      font-size: 12px;
      color: var(--muted);
      word-break: break-word;
    }

    .docActions{
      display:flex;
      align-items:center;
      justify-content:flex-end;
      flex: 0 0 auto;
    }

    .btn{
      display:inline-flex;
      align-items:center;
      gap: 10px;
      justify-content:center;
      padding: 10px 14px;
      border-radius: 999px;
      background: var(--btnBg);
      color: var(--btnFg);
      text-decoration:none;
      font-size: 13px;
      font-weight: 950;
      border: 1px solid rgba(15,23,42,.15);
      transition: background .15s ease, transform .15s ease;
      white-space: nowrap;
    }
    .btn:hover{ background: var(--btnHover); transform: translateY(-1px); }
    .btn:active{ transform: translateY(0); }

    .btn svg{ width: 18px; height: 18px; }

    .empty{
      padding: 14px;
      border-radius: 16px;
      border: 1px dashed rgba(15,23,42,.20);
      background: rgba(255,255,255,.65);
      color: var(--muted);
      font-weight: 750;
      line-height: 1.35;
    }

    /* Debug */
    details summary {
      cursor: pointer;
      user-select: none;
      font-weight: 950;
      color: var(--text);
      display:flex;
      align-items:center;
      gap: 10px;
    }
    details summary svg{ width: 18px; height: 18px; color: var(--muted); }
    details summary::-webkit-details-marker{ display:none; }

    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono"; font-size:12px; }
    .debugBox{
      white-space:pre-wrap;
      word-break:break-word;
      margin: 12px 0 0;
      background:#fafafa;
      border-radius: 14px;
      padding: 12px;
      border: 1px solid rgba(15,23,42,.08);
    }

    /* Footer */
    .footer{
      text-align:center;
      color: var(--muted);
      font-size: 12px;
      margin: 10px 0 4px;
    }
    .footer strong{ color: var(--text); }

    /* Reduced motion */
    @media (prefers-reduced-motion: reduce){
      .docCard, .btn{ transition: none; }
      .docCard:hover{ transform:none; }
      .btn:hover{ transform:none; }
    }
  </style>
</head>

<body>
  <div class="wrap">

    <!-- HEADER / BRAND -->
    <div class="card">
      <div class="header">
        <div class="brand">
          <div class="logo" aria-hidden="true">
            <!-- simple briefcase icon -->
            <svg viewBox="0 0 24 24" fill="none">
              <path d="M9 7V6a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v1" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M4 9h16v8a3 3 0 0 1-3 3H7a3 3 0 0 1-3-3V9Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
              <path d="M9 13h6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </div>
          <div>
            <h1>BewerbungsWerk</h1>
            <div class="sub">Sicherer Zugriff auf freigegebene Mietunterlagen – live aktualisiert</div>
          </div>
        </div>

        <div class="pillTag">Vermieteransicht</div>
      </div>

      <div class="statusGrid">
        <div class="statusCard">
          <div class="row">
            <div class="badge" style="background: transparent; border:0; padding:0; font-size:16px;">
              <span style="display:inline-grid;place-items:center;width:34px;height:34px;border-radius:12px;background:rgba(0,184,148,.12);border:1px solid rgba(0,184,148,.22);">
                <svg viewBox="0 0 24 24" fill="none" style="width:18px;height:18px;color:#0b6b2f;">
                  <path d="M20 6 9 17l-5-5" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </span>
              Status
            </div>

            <span id="conn" class="badge">Verbinden…</span>
          </div>

          <div class="row" style="justify-content:flex-start; margin-top:10px;">
            <span id="statusBadge" class="badge">Status: …</span>
            <span id="statusText" class="hintLine">–</span>
          </div>

          <div class="kpis">
            <div class="kpi">
              <div class="label">Aufrufe</div>
              <div class="value" id="views">–</div>
            </div>
            <div class="kpi">
              <div class="label">Zuletzt angesehen</div>
              <div class="value" id="lastViewed">–</div>
            </div>
            <div class="kpi">
              <div class="label">Ausgewählt</div>
              <div class="value" id="selCount">–</div>
            </div>
          </div>

          <div id="warning" class="warn"></div>
        </div>

        <div class="statusCard">
          <div class="row" style="justify-content:flex-start;">
            <div class="badge" style="background: transparent; border:0; padding:0; font-size:16px;">
              <span style="display:inline-grid;place-items:center;width:34px;height:34px;border-radius:12px;background:rgba(31,111,235,.12);border:1px solid rgba(31,111,235,.22);">
                <svg viewBox="0 0 24 24" fill="none" style="width:18px;height:18px;color:#12458f;">
                  <path d="M12 8v4l3 2" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </span>
              Hinweis
            </div>
          </div>

          <div class="hintLine" style="margin-top:10px; line-height:1.45;">
            Öffnen Sie nur die Dokumente, die Sie wirklich benötigen.
            Änderungen an der Freigabe werden live aktualisiert.
          </div>

          <div class="hintLine" style="margin-top:10px; line-height:1.45;">
            Wenn der Bewerber eine Freigabe widerruft oder die Zeit abläuft, wird das hier sofort angezeigt.
          </div>

          <div class="hintLine" style="margin-top:10px; line-height:1.45;">
            <strong>Datenschutz:</strong> Es gibt keine öffentlichen Storage-Links – Downloads laufen sicher über BewerbungsWerk.
          </div>
        </div>
      </div>
    </div>

    <!-- DOCUMENTS -->
    <div class="card">
      <div class="docsHeader">
        <div class="docsTitle">
          <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M4 7a2 2 0 0 1 2-2h5l2 2h7a2 2 0 0 1 2 2v8a3 3 0 0 1-3 3H7a3 3 0 0 1-3-3V7Z"
              stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
          </svg>
          Freigegebene Dokumente
        </div>
        <div class="docsCount" id="docsCount">– Dokumente freigegeben</div>
      </div>

      <div class="hintLine" id="docsHint" style="margin-top:8px;">Warte auf Updates…</div>

      <div id="docs" class="docsGrid" style="margin-top:14px;"></div>
    </div>

    <!-- DEBUG -->
    <div class="card">
      <details>
        <summary>
          <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M12 20a8 8 0 1 0-8-8 8 8 0 0 0 8 8Z" stroke="currentColor" stroke-width="2"/>
            <path d="M12 8v5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <path d="M12 16h.01" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
          </svg>
          Debug (optional)
        </summary>
        <div class="mono" id="dbgUrl" style="margin-top:10px; color: var(--muted);"></div>
        <pre class="mono debugBox" id="dbgJson"></pre>
      </details>
    </div>

    <div class="footer">
      <strong>BewerbungsWerk</strong> · Vermieteransicht · Live-Dokumentenfreigabe
    </div>

  </div>

<script>
(function () {
  const params = new URLSearchParams(window.location.search);
  const shareId = params.get("shareId");
  const token  = params.get("t");

  const elConn = document.getElementById("conn");
  const elStatusBadge = document.getElementById("statusBadge");
  const elStatusText = document.getElementById("statusText");
  const elViews = document.getElementById("views");
  const elLastViewed = document.getElementById("lastViewed");
  const elSelCount = document.getElementById("selCount");
  const elDocsHint = document.getElementById("docsHint");
  const elDocs = document.getElementById("docs");
  const elDocsCount = document.getElementById("docsCount");
  const elWarn = document.getElementById("warning");
  const elDbgUrl = document.getElementById("dbgUrl");
  const elDbgJson = document.getElementById("dbgJson");

  function setConn(text, ok) {
    elConn.textContent = text;
    elConn.className = "badge " + (ok ? "ok" : "bad");
  }

  function setStatus(ok, label, msg) {
    elStatusBadge.textContent = "Status: " + label;
    elStatusBadge.className = "badge " + (ok ? "ok" : "bad");
    elStatusText.textContent = msg || "";
  }

  function fmtDate(iso) {
    if (!iso) return "–";
    try { return new Date(iso).toLocaleString(); } catch (_) { return iso; }
  }

  function esc(s) {
    return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }

  function showWarn(text) {
    elWarn.style.display = text ? "block" : "none";
    elWarn.textContent = text || "";
  }

  function setDocsCount(n) {
    const num = Number(n || 0);
    elDocsCount.textContent = `${num} Dokument${num === 1 ? "" : "e"} freigegeben`;
  }

  if (!shareId || !token) {
    setConn("Fehler", false);
    setStatus(false, "BAD_REQUEST", "Fehlende Parameter (shareId / t).");
    showWarn("Die URL muss so aussehen: ?shareId=...&t=...");
    setDocsCount(0);
    elDocs.innerHTML = `<div class="empty">Fehlende Parameter in der URL: <span class="mono">shareId</span> und <span class="mono">t</span>.</div>`;
    return;
  }

  // stable viewer id
  const key = "bm_viewer_id";
  let viewerId = localStorage.getItem(key);
  if (!viewerId) {
    viewerId = (crypto.randomUUID ? crypto.randomUUID() : (Date.now() + "_" + Math.random()));
    localStorage.setItem(key, viewerId);
  }

  const FUNCTIONS_BASE = "https://cylqwswkekqwfefqmgya.functions.supabase.co";

  function buildDownloadUrl(docId) {
    return (
      FUNCTIONS_BASE +
      "/download" +
      "?shareId=" + encodeURIComponent(shareId) +
      "&t=" + encodeURIComponent(token) +
      "&docId=" + encodeURIComponent(docId)
    );
  }

  const streamUrl =
    FUNCTIONS_BASE + "/share_stream" +
    "?shareId=" + encodeURIComponent(shareId) +
    "&t=" + encodeURIComponent(token) +
    "&v=" + encodeURIComponent(viewerId);

  elDbgUrl.textContent = streamUrl;

  setConn("Verbinden…", true);
  setStatus(true, "…", "Warte auf Status…");
  setDocsCount(0);

  const es = new EventSource(streamUrl);

  es.addEventListener("open", () => {
    setConn("Live verbunden", true);
    showWarn("");
  });

  es.addEventListener("error", () => {
    setConn("Verbindung verloren (reconnect…)", false);
    showWarn("Die Live-Verbindung ist kurz unterbrochen. Der Browser verbindet automatisch erneut.");
  });

  es.addEventListener("status", (ev) => {
    try {
      const data = JSON.parse(ev.data);

      if (data.ok) {
        setStatus(true, "Freigabe aktiv", "Sie sehen die aktuell freigegebenen Dokumente.");
        if (typeof data.view_count !== "undefined") elViews.textContent = String(data.view_count);
        if (data.last_viewed_at) elLastViewed.textContent = fmtDate(data.last_viewed_at);
        if (data.warning) showWarn(String(data.warning));
      } else {
        setStatus(false, data.code || "INAKTIV", data.message || "");
        if (typeof data.view_count !== "undefined") elViews.textContent = String(data.view_count);
        if (data.last_viewed_at) elLastViewed.textContent = fmtDate(data.last_viewed_at);
      }
    } catch (_) {}
  });

  function extractDocs(payload) {
    if (Array.isArray(payload)) return payload;
    if (payload && Array.isArray(payload.documents)) return payload.documents;
    if (payload && Array.isArray(payload.docs)) return payload.docs;
    if (payload && payload.data && Array.isArray(payload.data.documents)) return payload.data.documents;
    if (payload && payload.data && Array.isArray(payload.data.docs)) return payload.data.docs;
    return [];
  }

  function extractSelectedIds(payload) {
    if (!payload) return [];
    const eff = payload.effectiveSelectedIds;
    const sel = payload.selectedIds;
    if (Array.isArray(eff)) return eff.filter(Boolean);
    if (Array.isArray(sel)) return sel.filter(Boolean);
    return [];
  }

  function filterDocsToSelected(docs, selectedIds) {
    if (!Array.isArray(docs)) return [];
    if (!Array.isArray(selectedIds) || selectedIds.length === 0) return [];
    const set = new Set(selectedIds);
    return docs.filter(d => d && d.id && set.has(d.id) && !d.missing);
  }

  function iconSvgForType(type) {
    const t = String(type || "").toLowerCase();

    // SCHUFA / Bonität
    if (t.includes("schufa") || t.includes("bon")) {
      return `
        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M7 11h10M7 15h7" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <path d="M8 3h6l4 4v14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
          <path d="M14 3v5h5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M9 19l1.5 1.5L14 17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>`;
    }

    // Gehalt / Einkommen
    if (t.includes("gehalt") || t.includes("income") || t.includes("salary") || t.includes("lohn")) {
      return `
        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M12 3v18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <path d="M17 7.5c0-1.9-2.1-3.5-5-3.5S7 5.6 7 7.5 9.1 11 12 11s5 1.6 5 3.5S14.9 18 12 18s-5-1.6-5-3.5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>`;
    }

    // Ausweis / Identität
    if (t.includes("ausweis") || t.includes("id") || t.includes("ident")) {
      return `
        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M4 7a3 3 0 0 1 3-3h10a3 3 0 0 1 3 3v10a3 3 0 0 1-3 3H7a3 3 0 0 1-3-3V7Z" stroke="currentColor" stroke-width="2"/>
          <path d="M9 10a2 2 0 1 0 0-4 2 2 0 0 0 0 4Z" stroke="currentColor" stroke-width="2"/>
          <path d="M7 18a4 4 0 0 1 8 0" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <path d="M14 9h5M14 12h5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>`;
    }

    // Mietvertrag / Wohnen / Wohnung
    if (t.includes("miet") || t.includes("vertrag") || t.includes("wohnung")) {
      return `
        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M3 11 12 3l9 8v10a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V11Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
          <path d="M9 22V12h6v10" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
        </svg>`;
    }

    // Konto / Bank
    if (t.includes("konto") || t.includes("bank") || t.includes("iban")) {
      return `
        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M3 10h18M4 20h16a2 2 0 0 0 2-2v-8a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2Z" stroke="currentColor" stroke-width="2"/>
          <path d="M7 16h4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>`;
    }

    // Default: Dokument
    return `
      <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
        <path d="M8 3h6l4 4v14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
        <path d="M14 3v5h5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M9 13h6M9 17h5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      </svg>`;
  }

  function prettyType(type) {
    const t = String(type || "").trim();
    if (!t) return "Dokument";
    // einfache "schufa" -> "SCHUFA"
    if (t.toLowerCase() === "schufa") return "SCHUFA";
    // Title Case
    return t.charAt(0).toUpperCase() + t.slice(1);
  }

  function renderDocs(docs, selectedIds, payload) {
    // counts
    const count = Array.isArray(selectedIds) ? selectedIds.length : 0;
    elSelCount.textContent = String(count);
    setDocsCount(count);

    // warnings (missing)
    if (payload && payload.missing) {
      const ids = Array.isArray(payload.missingIds) ? payload.missingIds : [];
      const short = ids.slice(0, 2).join(", ");
      const more = ids.length > 2 ? ` (+${ids.length - 2} weitere)` : "";
      showWarn(`Hinweis: ${ids.length} Dokument(e) sind nicht mehr verfügbar und werden ausgeblendet. ${short}${more}`);
    } else {
      showWarn("");
    }

    // empty states
    if (!Array.isArray(selectedIds) || selectedIds.length === 0) {
      elDocsHint.textContent = "Der Bewerber hat aktuell keine Dokumente freigegeben.";
      elDocs.innerHTML = `<div class="empty">Der Bewerber hat aktuell keine Dokumente freigegeben. Sobald Dokumente freigegeben werden, erscheint die Liste automatisch.</div>`;
      return;
    }

    if (!Array.isArray(docs) || docs.length === 0) {
      elDocsHint.textContent = "Auswahl ist leer (Dokumente fehlen oder wurden entfernt).";
      elDocs.innerHTML = `<div class="empty">Es sind Dokumente ausgewählt, aber aktuell nicht verfügbar. Das kann passieren, wenn der Bewerber Dokumente entfernt oder die Freigabe geändert hat.</div>`;
      return;
    }

    elDocsHint.textContent = "Klicken Sie auf „Dokument öffnen“, um ein freigegebenes Dokument anzusehen.";

    // render cards
    elDocs.innerHTML = "";
    for (const d of docs) {
      const title = (d && (d.title ?? d.name)) || "(ohne Titel)";
      const type  = (d && (d.type  ?? d.mime)) || "";
      const openUrl = buildDownloadUrl(d.id);

      const card = document.createElement("div");
      card.className = "docCard";
      card.innerHTML = `
        <div class="docIcon" aria-hidden="true">
          ${iconSvgForType(type)}
        </div>

        <div class="docMain">
          <div class="docName">${esc(title)}</div>
          <div class="docMeta">
            <span class="pill">${esc(prettyType(type))}</span>
          </div>
          <div class="docId mono">${esc(d.id)}</div>
        </div>

        <div class="docActions">
          <a class="btn" href="${esc(openUrl)}" target="_blank" rel="noopener">
            <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M15 3h6v6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M10 14 21 3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M21 14v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h6" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
            </svg>
            Dokument öffnen
          </a>
        </div>
      `;
      elDocs.appendChild(card);
    }
  }

  function handleUpdate(ev) {
    try {
      const payload = JSON.parse(ev.data);
      elDbgJson.textContent = JSON.stringify(payload, null, 2);

      const selectedIds = extractSelectedIds(payload);
      const rawDocs = extractDocs(payload);
      const docs = filterDocsToSelected(rawDocs, selectedIds);

      renderDocs(docs, selectedIds, payload);
    } catch (e) {
      elDbgJson.textContent = "JSON Parse Error:\n" + String(ev.data);
    }
  }

  setConn("Verbinden…", true);
  setStatus(true, "…", "Warte auf Status…");
  setDocsCount(0);

  const es = new EventSource(streamUrl);
  es.addEventListener("update", handleUpdate);
  es.onmessage = handleUpdate;

})();
</script>
</body>
</html>
