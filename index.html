<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BewerbungsWerk – Vermieteransicht</title>

  <style>
    :root{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color-scheme: light;

      --bg: #f5f7fb;
      --card: #ffffff;
      --text: #0f172a;
      --muted: #64748b;

      --brandA: #1f6feb;
      --brandB: #00b894;

      --radius: 18px;
      --shadow: 0 12px 30px rgba(2,6,23,.08);
      --border: rgba(15,23,42,.10);

      --okBg: #e8f7ee;
      --okFg: #0b6b2f;

      --badBg: #fdecec;
      --badFg: #8a1414;

      --chipBg: #eef2f6;
      --chipFg: #111827;

      --btnBg: #0f172a;
      --btnFg: #fff;
      --btnHover: #142043;

      --warnBg: #fff7e6;
      --warnFg: #7a4b00;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      background:
        radial-gradient(1200px 600px at 15% -10%, rgba(31,111,235,.12), transparent 60%),
        radial-gradient(900px 500px at 95% 0%, rgba(0,184,148,.12), transparent 55%),
        var(--bg);
      color: var(--text);
      padding: 18px;
    }

    .wrap{ max-width: 980px; margin: 0 auto; }

    .card{
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      border: 1px solid rgba(15,23,42,.06);
      padding: 18px;
      margin-bottom: 14px;
    }

    /* Header (Brand + Vermieteransicht) */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      flex-wrap: wrap;
    }

    .brand{
      display:flex;
      align-items:center;
      gap: 12px;
      min-width: 260px;
    }

    .logo{
      width: 44px;
      height: 44px;
      border-radius: 14px;
      background: linear-gradient(135deg, var(--brandA), var(--brandB));
      box-shadow: 0 10px 20px rgba(31,111,235,.16);
      display:grid;
      place-items:center;
      flex: 0 0 auto;
    }
    .logo svg{ width: 26px; height: 26px; color:#fff; }

    .brandTitle{
      margin:0;
      font-size: 34px;
      font-weight: 1000;
      letter-spacing: -0.04em;
      line-height: 1.05;
    }

    .brandSub{
      margin-top: 6px;
      color: var(--muted);
      font-size: 14px;
      font-weight: 700;
    }

    .rolePill{
      padding: 10px 14px;
      border-radius: 999px;
      font-weight: 950;
      border: 1px solid rgba(11,107,47,.18);
      background: linear-gradient(180deg, rgba(0,184,148,.20), rgba(0,184,148,.10));
      color: var(--okFg);
      white-space: nowrap;
    }

    /* Status Panel */
    .statusCard{
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 16px;
      background: linear-gradient(180deg, rgba(15,23,42,.02), transparent 60%);
      margin-top: 14px;
    }

    .statusHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      flex-wrap: wrap;
    }

    .statusLeft{
      display:flex;
      align-items:center;
      gap: 10px;
      font-size: 18px;
      font-weight: 1000;
    }

    .statusLeft .dotIcon{
      width: 34px;
      height: 34px;
      border-radius: 12px;
      display:grid;
      place-items:center;
      background: rgba(0,184,148,.12);
      border: 1px solid rgba(0,184,148,.22);
    }
    .statusLeft .dotIcon svg{ width: 18px; height: 18px; color: var(--okFg); }

    .badge{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 999px;
      font-weight: 950;
      font-size: 13px;
      background: var(--chipBg);
      color: var(--chipFg);
      border: 1px solid rgba(15,23,42,.08);
      white-space: nowrap;
    }

    .ok{ background: var(--okBg); color: var(--okFg); border-color: rgba(11,107,47,.18); }
    .bad{ background: var(--badBg); color: var(--badFg); border-color: rgba(138,20,20,.18); }

    .miniRow{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items:center;
      margin-top: 12px;
    }

    .miniChip{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(15,23,42,.08);
      background: #fff;
      box-shadow: 0 6px 18px rgba(2,6,23,.05);
      font-weight: 900;
      color: #111827;
      white-space: nowrap;
    }
    .miniChip svg{ width: 18px; height: 18px; color: #334155; opacity:.9; }
    .miniChip .muted{ color: var(--muted); font-weight: 800; }

    .warn{
      margin-top: 12px;
      background: var(--warnBg);
      color: var(--warnFg);
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid rgba(122,75,0,.18);
      display:none;
      font-weight: 800;
    }

    /* Documents */
    .docsTop{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap: 12px;
      flex-wrap: wrap;
    }

    .docsTitle{
      display:flex;
      align-items:center;
      gap: 10px;
      font-size: 22px;
      font-weight: 1000;
      letter-spacing: -0.02em;
    }
    .docsTitle svg{ width: 22px; height: 22px; color: var(--brandA); }

    .docsCount{
      padding: 10px 12px;
      border-radius: 999px;
      background: rgba(31,111,235,.08);
      border: 1px solid rgba(31,111,235,.18);
      color: #12458f;
      font-weight: 950;
      white-space: nowrap;
    }

    .docsHint{
      margin-top: 6px;
      color: var(--muted);
      font-weight: 750;
    }

    .list{
      margin-top: 14px;
      display:flex;
      flex-direction:column;
      gap: 12px;
    }

    .docRow{
      display:flex;
      gap: 14px;
      align-items:center;
      justify-content:space-between;
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 14px;
      background: #fff;
      box-shadow: 0 6px 18px rgba(2,6,23,.05);
    }

    .docLeft{
      display:flex;
      gap: 12px;
      align-items:center;
      min-width: 0;
      flex: 1 1 auto;
    }

    .docIcon{
      width: 54px;
      height: 54px;
      border-radius: 16px;
      display:grid;
      place-items:center;
      flex: 0 0 auto;
      border: 1px solid rgba(15,23,42,.08);
      background: linear-gradient(180deg, rgba(31,111,235,.10), rgba(0,184,148,.08));
    }
    .docIcon svg{ width: 28px; height: 28px; color: #0f172a; opacity: .92; }

    .docMain{ min-width: 0; }
    .docName{
      margin: 0;
      font-size: 18px;
      font-weight: 1000;
      letter-spacing: -0.02em;
      line-height: 1.15;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 520px;
    }
    .docSub{
      margin-top: 6px;
      color: var(--muted);
      font-weight: 800;
    }
    .docId{
      margin-top: 6px;
      color: var(--muted);
      font-size: 12px;
      font-weight: 700;
      word-break: break-word;
    }

    .btn{
      display:inline-flex;
      align-items:center;
      gap: 10px;
      justify-content:center;
      padding: 10px 14px;
      border-radius: 999px;
      background: var(--btnBg);
      color: var(--btnFg);
      text-decoration:none;
      font-size: 13px;
      font-weight: 950;
      border: 1px solid rgba(15,23,42,.15);
      transition: background .15s ease, transform .15s ease;
      white-space: nowrap;
      flex: 0 0 auto;
    }
    .btn:hover{ background: var(--btnHover); transform: translateY(-1px); }
    .btn svg{ width: 18px; height: 18px; }

    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono";
      font-size: 12px;
    }

    .empty{
      padding: 14px;
      border-radius: 16px;
      border: 1px dashed rgba(15,23,42,.22);
      background: rgba(255,255,255,.7);
      color: var(--muted);
      font-weight: 800;
      line-height: 1.35;
    }

    /* Responsive: doc row stacks on mobile */
    @media (max-width: 720px){
      .brandTitle{ font-size: 30px; }
      .docRow{ flex-direction:column; align-items:stretch; }
      .btn{ width: 100%; justify-content:center; }
      .docName{ max-width: 100%; }
    }

    /* Debug */
    details summary{
      cursor:pointer;
      user-select:none;
      font-weight: 950;
      display:flex;
      align-items:center;
      gap: 8px;
    }
    details summary::-webkit-details-marker{ display:none; }

    .debugBox{
      white-space:pre-wrap;
      word-break:break-word;
      margin-top: 12px;
      background:#fafafa;
      border-radius: 14px;
      padding: 12px;
      border: 1px solid rgba(15,23,42,.08);
    }
  </style>
</head>

<body>
<div class="wrap">

  <!-- HEADER -->
  <div class="card">
    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true">
          <!-- Briefcase -->
          <svg viewBox="0 0 24 24" fill="none">
            <path d="M9 7V6a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v1" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <path d="M4 9h16v8a3 3 0 0 1-3 3H7a3 3 0 0 1-3-3V9Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
            <path d="M9 13h6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </div>
        <div>
          <div class="brandTitle">BewerbungsWerk</div>
          <div class="brandSub">Sicherer Zugriff auf freigegebene Mietunterlagen – live aktualisiert</div>
        </div>
      </div>

      <div class="rolePill">Vermieteransicht</div>
    </div>

    <!-- STATUS PANEL -->
    <div class="statusCard">
      <div class="statusHeader">
        <div class="statusLeft">
          <div class="dotIcon" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none">
              <path d="M20 6 9 17l-5-5" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
          Status
        </div>
        <span id="conn" class="badge">Verbinden…</span>
      </div>

      <div class="miniRow">
        <span id="statusBadge" class="badge">Status: …</span>
        <span id="statusText" class="docsHint">–</span>
      </div>

      <div class="miniRow">
        <div class="miniChip">
          <!-- eye -->
          <svg viewBox="0 0 24 24" fill="none"><path d="M2 12s3.5-7 10-7 10 7 10 7-3.5 7-10 7S2 12 2 12Z" stroke="currentColor" stroke-width="2"/><path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z" stroke="currentColor" stroke-width="2"/></svg>
          <span class="muted">Aufrufe</span>
          <span id="views">–</span>
        </div>
        <div class="miniChip">
          <!-- clock -->
          <svg viewBox="0 0 24 24" fill="none"><path d="M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" stroke="currentColor" stroke-width="2"/><path d="M12 7v5l3 2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
          <span class="muted">Zuletzt angesehen</span>
          <span id="lastViewed">–</span>
        </div>
        <div class="miniChip">
          <!-- check -->
          <svg viewBox="0 0 24 24" fill="none"><path d="M20 6 9 17l-5-5" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/></svg>
          <span class="muted">Ausgewählt</span>
          <span id="selCount">–</span>
        </div>
      </div>

      <div id="warning" class="warn"></div>
    </div>
  </div>

  <!-- DOCUMENTS -->
  <div class="card">
    <div class="docsTop">
      <div>
        <div class="docsTitle">
          <!-- folder -->
          <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M4 7a2 2 0 0 1 2-2h5l2 2h7a2 2 0 0 1 2 2v8a3 3 0 0 1-3 3H7a3 3 0 0 1-3-3V7Z"
              stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
          </svg>
          Freigegebene Dokumente
        </div>
        <div class="docsHint" id="docsHint">Warte auf Updates…</div>
      </div>
      <div class="docsCount" id="docsCount">– Dokumente freigegeben</div>
    </div>

    <div id="docs" class="list"></div>
  </div>

  <!-- DEBUG -->
  <div class="card">
    <details>
      <summary>Debug (optional)</summary>
      <div class="mono" id="dbgUrl" style="margin-top:10px; color: var(--muted);"></div>
      <pre class="mono debugBox" id="dbgJson"></pre>
    </details>
  </div>

</div>

<script>
(function () {
  const params = new URLSearchParams(window.location.search);
  const shareId = params.get("shareId");
  const token  = params.get("t");

  const elConn = document.getElementById("conn");
  const elStatusBadge = document.getElementById("statusBadge");
  const elStatusText = document.getElementById("statusText");
  const elViews = document.getElementById("views");
  const elLastViewed = document.getElementById("lastViewed");
  const elSelCount = document.getElementById("selCount");
  const elDocsHint = document.getElementById("docsHint");
  const elDocs = document.getElementById("docs");
  const elDocsCount = document.getElementById("docsCount");
  const elWarn = document.getElementById("warning");
  const elDbgUrl = document.getElementById("dbgUrl");
  const elDbgJson = document.getElementById("dbgJson");

  function esc(s) {
    return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }

  function setConn(text, ok) {
    elConn.textContent = text;
    elConn.className = "badge " + (ok ? "ok" : "bad");
  }

  function setStatus(ok, label, msg) {
    elStatusBadge.textContent = "Status: " + label;
    elStatusBadge.className = "badge " + (ok ? "ok" : "bad");
    elStatusText.textContent = msg || "";
  }

  function fmtDate(iso) {
    if (!iso) return "–";
    try { return new Date(iso).toLocaleString(); } catch (_) { return iso; }
  }

  function showWarn(text) {
    elWarn.style.display = text ? "block" : "none";
    elWarn.textContent = text || "";
  }

  function setDocsCount(n) {
    const num = Number(n || 0);
    elDocsCount.textContent = `${num} Dokument${num === 1 ? "" : "e"} freigegeben`;
  }

  if (!shareId || !token) {
    setConn("Fehler", false);
    setStatus(false, "BAD_REQUEST", "Fehlende Parameter (shareId / t).");
    showWarn("Die URL muss so aussehen: ?shareId=...&t=...");
    setDocsCount(0);
    elDocsHint.textContent = "Fehler: URL unvollständig";
    elDocs.innerHTML = `<div class="empty">Fehlende Parameter in der URL: <span class="mono">shareId</span> und <span class="mono">t</span>.</div>`;
    return;
  }

  // stable viewer id
  const key = "bm_viewer_id";
  let viewerId = localStorage.getItem(key);
  if (!viewerId) {
    viewerId = (crypto.randomUUID ? crypto.randomUUID() : (Date.now() + "_" + Math.random()));
    localStorage.setItem(key, viewerId);
  }

  const FUNCTIONS_BASE = "https://cylqwswkekqwfefqmgya.functions.supabase.co";

  function buildDownloadUrl(docId) {
    return (
      FUNCTIONS_BASE +
      "/download" +
      "?shareId=" + encodeURIComponent(shareId) +
      "&t=" + encodeURIComponent(token) +
      "&docId=" + encodeURIComponent(docId)
    );
  }

  const streamUrl =
    FUNCTIONS_BASE + "/share_stream" +
    "?shareId=" + encodeURIComponent(shareId) +
    "&t=" + encodeURIComponent(token) +
    "&v=" + encodeURIComponent(viewerId);

  elDbgUrl.textContent = streamUrl;

  function extractDocs(payload) {
    if (Array.isArray(payload)) return payload;
    if (payload && Array.isArray(payload.documents)) return payload.documents;
    if (payload && Array.isArray(payload.docs)) return payload.docs;
    return [];
  }

  function extractSelectedIds(payload) {
    if (!payload) return [];
    const eff = payload.effectiveSelectedIds;
    const sel = payload.selectedIds;
    if (Array.isArray(eff)) return eff.filter(Boolean);
    if (Array.isArray(sel)) return sel.filter(Boolean);
    return [];
  }

  function filterDocsToSelected(docs, selectedIds) {
    if (!Array.isArray(docs)) return [];
    if (!Array.isArray(selectedIds) || selectedIds.length === 0) return [];
    const set = new Set(selectedIds);
    return docs.filter(d => d && d.id && set.has(d.id) && !d.missing);
  }

  function iconSvgForType(type) {
    const t = String(type || "").toLowerCase();

    // SCHUFA / Bonität
    if (t.includes("schufa") || t.includes("bon")) {
      return `<svg viewBox="0 0 24 24" fill="none">
        <path d="M7 11h10M7 15h7" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        <path d="M8 3h6l4 4v14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
        <path d="M14 3v5h5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M9 19l1.5 1.5L14 17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>`;
    }

    // Einkommen / Gehalt
    if (t.includes("gehalt") || t.includes("income") || t.includes("salary") || t.includes("lohn")) {
      return `<svg viewBox="0 0 24 24" fill="none">
        <path d="M12 3v18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        <path d="M17 7.5c0-1.9-2.1-3.5-5-3.5S7 5.6 7 7.5 9.1 11 12 11s5 1.6 5 3.5S14.9 18 12 18s-5-1.6-5-3.5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      </svg>`;
    }

    // Ausweis
    if (t.includes("ausweis") || t.includes("id") || t.includes("ident")) {
      return `<svg viewBox="0 0 24 24" fill="none">
        <path d="M4 7a3 3 0 0 1 3-3h10a3 3 0 0 1 3 3v10a3 3 0 0 1-3 3H7a3 3 0 0 1-3-3V7Z" stroke="currentColor" stroke-width="2"/>
        <path d="M9 10a2 2 0 1 0 0-4 2 2 0 0 0 0 4Z" stroke="currentColor" stroke-width="2"/>
        <path d="M7 18a4 4 0 0 1 8 0" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        <path d="M14 9h5M14 12h5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      </svg>`;
    }

    // Default Dokument
    return `<svg viewBox="0 0 24 24" fill="none">
      <path d="M8 3h6l4 4v14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
      <path d="M14 3v5h5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      <path d="M9 13h6M9 17h5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
    </svg>`;
  }

  function prettyType(type) {
    const t = String(type || "").trim();
    if (!t) return "Dokument";
    if (t.toLowerCase() === "schufa") return "SCHUFA-Auskunft";
    if (t.toLowerCase() === "income_proof") return "Gehaltsnachweis";
    return t.charAt(0).toUpperCase() + t.slice(1);
  }

  function renderDocs(docs, selectedIds, payload) {
    const count = Array.isArray(selectedIds) ? selectedIds.length : 0;
    elSelCount.textContent = String(count);
    setDocsCount(count);

    if (payload && payload.missing) {
      const ids = Array.isArray(payload.missingIds) ? payload.missingIds : [];
      showWarn(`Hinweis: ${ids.length} Dokument(e) sind nicht mehr verfügbar und werden ausgeblendet.`);
    } else {
      showWarn("");
    }

    if (!Array.isArray(selectedIds) || selectedIds.length === 0) {
      elDocsHint.textContent = "Der Bewerber hat aktuell keine Dokumente freigegeben.";
      elDocs.innerHTML = `<div class="empty">Der Bewerber hat aktuell keine Dokumente freigegeben. Sobald Dokumente freigegeben werden, erscheint die Liste automatisch.</div>`;
      return;
    }

    if (!Array.isArray(docs) || docs.length === 0) {
      elDocsHint.textContent = "Auswahl ist leer (Dokumente fehlen oder wurden entfernt).";
      elDocs.innerHTML = `<div class="empty">Die freigegebenen Dokumente sind gerade nicht verfügbar. Bitte aktualisieren Sie die Seite oder warten Sie kurz.</div>`;
      return;
    }

    elDocsHint.textContent = "Klicken Sie auf „Dokument öffnen“, um ein freigegebenes Dokument anzusehen.";
    elDocs.innerHTML = "";

    for (const d of docs) {
      const title = (d && (d.title ?? d.name)) || "(ohne Titel)";
      const type  = (d && (d.type  ?? d.mime)) || "";
      const openUrl = buildDownloadUrl(d.id);

      const row = document.createElement("div");
      row.className = "docRow";
      row.innerHTML = `
        <div class="docLeft">
          <div class="docIcon" aria-hidden="true">${iconSvgForType(type)}</div>
          <div class="docMain">
            <div class="docName">${esc(title)}</div>
            <div class="docSub">${esc(prettyType(type))}</div>
            <div class="docId mono">${esc(d.id)}</div>
          </div>
        </div>
        <a class="btn" href="${esc(openUrl)}" target="_blank" rel="noopener">
          <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M15 3h6v6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M10 14 21 3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <path d="M21 14v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h6" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
          </svg>
          Dokument öffnen
        </a>
      `;
      elDocs.appendChild(row);
    }
  }

  function handleUpdate(ev) {
    try {
      const payload = JSON.parse(ev.data);
      elDbgJson.textContent = JSON.stringify(payload, null, 2);

      const selectedIds = extractSelectedIds(payload);
      const rawDocs = extractDocs(payload);
      const docs = filterDocsToSelected(rawDocs, selectedIds);

      renderDocs(docs, selectedIds, payload);
    } catch (e) {
      elDbgJson.textContent = "JSON Parse Error:\n" + String(ev.data);
    }
  }

  // Init UI
  setConn("Verbinden…", true);
  setStatus(true, "…", "Warte auf Status…");
  setDocsCount(0);

  // SSE
  const es = new EventSource(
    "https://cylqwswkekqwfefqmgya.functions.supabase.co/share_stream" +
    "?shareId=" + encodeURIComponent(shareId) +
    "&t=" + encodeURIComponent(token) +
    "&v=" + encodeURIComponent(viewerId)
  );

  es.addEventListener("open", () => setConn("Live verbunden", true));
  es.addEventListener("error", () => setConn("Reconnecting…", false));

  es.addEventListener("status", (ev) => {
    try{
      const data = JSON.parse(ev.data);
      if (data.ok) {
        setStatus(true, "Freigabe aktiv", "Live-Ansicht ist aktiv.");
        if (typeof data.view_count !== "undefined") elViews.textContent = String(data.view_count);
        if (data.last_viewed_at) elLastViewed.textContent = fmtDate(data.last_viewed_at);
      } else {
        setStatus(false, data.code || "INAKTIV", data.message || "");
      }
    }catch(_){}
  });

  es.addEventListener("update", handleUpdate);
  es.onmessage = handleUpdate;

})();
</script>
</body>
</html>
