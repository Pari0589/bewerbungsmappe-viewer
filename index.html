<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bewerbungsmappe – Sichere Dokumentenfreigabe</title>
  <style>
    :root {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      --bg: #f6f7f9;
      --card: #ffffff;
      --text: #0f172a;
      --muted: #64748b;
      --shadow: 0 10px 30px rgba(2, 6, 23, .08);
      --shadow-soft: 0 6px 18px rgba(2, 6, 23, .06);
      --radius: 18px;

      --ok-bg: #e8f7ee;
      --ok-fg: #0b6b2f;

      --bad-bg: #fdecec;
      --bad-fg: #8a1414;

      --warn-bg: #fff7e6;
      --warn-fg: #7a4b00;

      --pill-bg: #f1f5f9;
      --pill-fg: #334155;

      --btn-bg: #0f172a;
      --btn-fg: #ffffff;
      --btn-bg-hover: #111c33;

      --border: rgba(15, 23, 42, .10);
    }

    body { margin:0; background:var(--bg); color:var(--text); padding:22px; }
    .wrap { max-width: 980px; margin: 0 auto; }

    .card {
      background:var(--card);
      border-radius: var(--radius);
      padding: 18px;
      box-shadow: var(--shadow);
      margin-bottom: 14px;
      border: 1px solid rgba(15, 23, 42, .06);
    }

    .row {
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }

    .title {
      margin:0;
      font-size: 24px;
      font-weight: 900;
      letter-spacing: -0.02em;
      line-height: 1.15;
    }

    .subtitle {
      display:block;
      margin-top: 6px;
      font-size: 13px;
      font-weight: 600;
      color: var(--muted);
    }

    .badge {
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:7px 12px;
      border-radius:999px;
      font-weight:900;
      font-size:13px;
      background: #eef2f6;
      color: #1f2937;
      border: 1px solid rgba(15, 23, 42, .08);
    }
    .ok { background: var(--ok-bg); color: var(--ok-fg); border-color: rgba(11,107,47,.20); }
    .bad { background: var(--bad-bg); color: var(--bad-fg); border-color: rgba(138,20,20,.18); }

    .muted { color: var(--muted); }
    .kv { display:flex; gap:18px; flex-wrap:wrap; margin-top:12px; }
    .kv > div { min-width: 180px; }
    .label { font-size:12px; color:var(--muted); margin-bottom:4px; }
    .value { font-size:14px; font-weight:900; }

    .warn {
      background: var(--warn-bg);
      color: var(--warn-fg);
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid rgba(122,75,0,.18);
    }

    .mono {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono";
      font-size: 12px;
    }

    /* Docs list -> cards */
    ul { margin:12px 0 0; padding:0; }
    li { list-style:none; }

    .docs-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
      margin-top: 12px;
    }
    @media (min-width: 760px) {
      .docs-grid { grid-template-columns: 1fr 1fr; }
    }

    .doc-card {
      background: #fff;
      border-radius: 16px;
      padding: 16px;
      box-shadow: var(--shadow-soft);
      border: 1px solid var(--border);
      transition: transform .15s ease, box-shadow .15s ease;
    }
    .doc-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 14px 34px rgba(2, 6, 23, .10);
    }

    .doc-title {
      font-size: 16px;
      font-weight: 1000;
      margin: 0 0 6px 0;
      letter-spacing: -0.01em;
    }

    .doc-meta {
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      margin-bottom: 12px;
    }

    .pill {
      display:inline-flex;
      align-items:center;
      padding: 4px 10px;
      border-radius: 999px;
      background: var(--pill-bg);
      color: var(--pill-fg);
      font-size: 12px;
      font-weight: 900;
      border: 1px solid rgba(51,65,85,.10);
    }

    .doc-id {
      font-size: 12px;
      color: var(--muted);
      margin: 0 0 12px 0;
      word-break: break-word;
    }

    .btn {
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding: 10px 14px;
      border-radius: 999px;
      background: var(--btn-bg);
      color: var(--btn-fg);
      text-decoration:none;
      font-size: 13px;
      font-weight: 900;
      border: 1px solid rgba(15, 23, 42, .15);
      transition: background .15s ease, transform .15s ease;
      user-select: none;
    }
    .btn:hover { background: var(--btn-bg-hover); transform: translateY(-1px); }
    .btn:active { transform: translateY(0); }

    .hint {
      font-size: 13px;
      color: var(--muted);
    }

    /* Debug collapse */
    details summary {
      cursor: pointer;
      user-select: none;
      font-weight: 900;
      color: var(--text);
    }
    details summary::-webkit-details-marker { display:none; }
    .debug-box {
      white-space: pre-wrap;
      word-break: break-word;
      margin: 12px 0 0;
      background: #fafafa;
      border-radius: 14px;
      padding: 12px;
      border: 1px solid rgba(15,23,42,.08);
    }

    .topbar {
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      justify-content:space-between;
    }
  </style>
</head>
<body>
<div class="wrap">

  <div class="card">
    <div class="topbar">
      <div>
        <h1 class="title">Bewerbungsmappe
          <span class="subtitle">Sichere Dokumentenfreigabe – live aktualisiert</span>
        </h1>
      </div>
      <span id="conn" class="badge">Verbinden…</span>
    </div>

    <div class="row" style="justify-content:flex-start; margin-top:12px;">
      <span id="statusBadge" class="badge">Status: …</span>
      <span id="statusText" class="muted">–</span>
    </div>

    <div class="kv">
      <div>
        <div class="label">Aufrufe</div>
        <div class="value" id="views">–</div>
      </div>
      <div>
        <div class="label">Zuletzt angesehen</div>
        <div class="value" id="lastViewed">–</div>
      </div>
      <div>
        <div class="label">Ausgewählt</div>
        <div class="value" id="selCount">–</div>
      </div>
    </div>

    <div id="warning" class="warn" style="display:none; margin-top:12px;"></div>
  </div>

  <div class="card">
    <div class="row" style="justify-content:flex-start;">
      <div style="font-size:16px;font-weight:1000;">Dokumente</div>
      <div class="hint" id="docsHint">Warte auf Updates…</div>
    </div>

    <div id="docs" class="docs-grid"></div>
  </div>

  <div class="card">
    <details>
      <summary>Debug (optional)</summary>
      <div class="muted mono" id="dbgUrl" style="margin-top:10px;"></div>
      <pre class="mono debug-box" id="dbgJson"></pre>
    </details>
  </div>

</div>

<script>
(function () {
  const params = new URLSearchParams(window.location.search);
  const shareId = params.get("shareId");
  const token  = params.get("t");

  const elConn = document.getElementById("conn");
  const elStatusBadge = document.getElementById("statusBadge");
  const elStatusText = document.getElementById("statusText");
  const elViews = document.getElementById("views");
  const elLastViewed = document.getElementById("lastViewed");
  const elSelCount = document.getElementById("selCount");
  const elDocsHint = document.getElementById("docsHint");
  const elDocs = document.getElementById("docs");
  const elWarn = document.getElementById("warning");
  const elDbgUrl = document.getElementById("dbgUrl");
  const elDbgJson = document.getElementById("dbgJson");

  function setConn(text, ok) {
    elConn.textContent = text;
    elConn.className = "badge " + (ok ? "ok" : "bad");
  }

  function setStatus(ok, label, msg) {
    elStatusBadge.textContent = "Status: " + label;
    elStatusBadge.className = "badge " + (ok ? "ok" : "bad");
    elStatusText.textContent = msg || "";
  }

  function fmtDate(iso) {
    if (!iso) return "–";
    try { return new Date(iso).toLocaleString(); } catch (_) { return iso; }
  }

  function esc(s) {
    return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }

  function showWarn(text) {
    elWarn.style.display = text ? "block" : "none";
    elWarn.textContent = text || "";
  }

  if (!shareId || !token) {
    setConn("Fehler", false);
    setStatus(false, "BAD_REQUEST", "Fehlende Parameter (shareId / t).");
    showWarn("Die URL muss so aussehen: ?shareId=...&t=...");
    return;
  }

  // stable viewer id
  const key = "bm_viewer_id";
  let viewerId = localStorage.getItem(key);
  if (!viewerId) {
    viewerId = (crypto.randomUUID ? crypto.randomUUID() : (Date.now() + "_" + Math.random()));
    localStorage.setItem(key, viewerId);
  }

  const FUNCTIONS_BASE = "https://cylqwswkekqwfefqmgya.functions.supabase.co";

  function buildDownloadUrl(docId) {
    return (
      FUNCTIONS_BASE +
      "/download" +
      "?shareId=" + encodeURIComponent(shareId) +
      "&t=" + encodeURIComponent(token) +
      "&docId=" + encodeURIComponent(docId)
    );
  }

  const streamUrl =
    FUNCTIONS_BASE + "/share_stream" +
    "?shareId=" + encodeURIComponent(shareId) +
    "&t=" + encodeURIComponent(token) +
    "&v=" + encodeURIComponent(viewerId);

  elDbgUrl.textContent = streamUrl;

  setConn("Verbinden…", true);
  setStatus(true, "…", "Warte auf Status…");

  const es = new EventSource(streamUrl);

  es.addEventListener("open", () => {
    setConn("Live verbunden", true);
    showWarn("");
  });

  es.addEventListener("error", () => {
    setConn("Verbindung verloren (reconnect…)", false);
    showWarn("Die Verbindung zum Live-Stream ist unterbrochen. Der Browser versucht automatisch neu zu verbinden.");
  });

  es.addEventListener("status", (ev) => {
    try {
      const data = JSON.parse(ev.data);

      if (data.ok) {
        setStatus(true, "Aktiv", "Live-Ansicht ist aktiv.");
        if (typeof data.view_count !== "undefined") elViews.textContent = String(data.view_count);
        if (data.last_viewed_at) elLastViewed.textContent = fmtDate(data.last_viewed_at);
        if (data.warning) showWarn(String(data.warning));
      } else {
        setStatus(false, data.code || "INAKTIV", data.message || "");
        if (typeof data.view_count !== "undefined") elViews.textContent = String(data.view_count);
        if (data.last_viewed_at) elLastViewed.textContent = fmtDate(data.last_viewed_at);
      }
    } catch (_) {}
  });

  function extractDocs(payload) {
    if (Array.isArray(payload)) return payload;
    if (payload && Array.isArray(payload.documents)) return payload.documents;
    if (payload && Array.isArray(payload.docs)) return payload.docs;
    if (payload && payload.data && Array.isArray(payload.data.documents)) return payload.data.documents;
    if (payload && payload.data && Array.isArray(payload.data.docs)) return payload.data.docs;
    return [];
  }

  function extractSelectedIds(payload) {
    if (!payload) return [];
    const eff = payload.effectiveSelectedIds;
    const sel = payload.selectedIds;
    if (Array.isArray(eff)) return eff.filter(Boolean);
    if (Array.isArray(sel)) return sel.filter(Boolean);
    return [];
  }

  function filterDocsToSelected(docs, selectedIds) {
    if (!Array.isArray(docs)) return [];
    if (!Array.isArray(selectedIds) || selectedIds.length === 0) return [];
    const set = new Set(selectedIds);
    return docs.filter(d => d && d.id && set.has(d.id) && !d.missing);
  }

  function renderDocs(docs, selectedIds, payload) {
    // counts
    elSelCount.textContent = String(Array.isArray(selectedIds) ? selectedIds.length : 0);

    // warnings (missing)
    if (payload && payload.missing) {
      const ids = Array.isArray(payload.missingIds) ? payload.missingIds : [];
      const short = ids.slice(0, 3).join(", ");
      const more = ids.length > 3 ? ` (+${ids.length - 3} weitere)` : "";
      showWarn(`Hinweis: ${ids.length} Dokument(e) sind nicht mehr verfügbar und werden ausgeblendet. ${short}${more}`);
    } else {
      showWarn("");
    }

    // empty states
    if (!Array.isArray(selectedIds) || selectedIds.length === 0) {
      elDocsHint.textContent = "Keine Dokumente ausgewählt.";
      elDocs.innerHTML = "<div class='muted'>Keine Dokumente ausgewählt.</div>";
      return;
    }

    if (!Array.isArray(docs) || docs.length === 0) {
      elDocsHint.textContent = "Auswahl ist leer (Dokumente fehlen oder wurden entfernt).";
      elDocs.innerHTML = "<div class='muted'>Auswahl ist leer (Dokumente fehlen oder wurden entfernt).</div>";
      return;
    }

    elDocsHint.textContent = "Freigegebene Dokumente (live):";

    // render cards
    elDocs.innerHTML = "";
    for (const d of docs) {
      const title = (d && (d.title ?? d.name)) || "(ohne Titel)";
      const type  = (d && (d.type  ?? d.mime)) || "(ohne Typ)";
      const openUrl = buildDownloadUrl(d.id);

      const card = document.createElement("div");
      card.className = "doc-card";
      card.innerHTML = `
        <div class="doc-title">${esc(title)}</div>
        <div class="doc-meta">
          <span class="pill">${esc(type)}</span>
        </div>
        <div class="doc-id mono">${esc(d.id)}</div>
        <a class="btn" href="${esc(openUrl)}" target="_blank" rel="noopener">Dokument öffnen</a>
      `;
      elDocs.appendChild(card);
    }
  }

  function handleUpdate(ev) {
    try {
      const payload = JSON.parse(ev.data);
      elDbgJson.textContent = JSON.stringify(payload, null, 2);

      const selectedIds = extractSelectedIds(payload);
      const rawDocs = extractDocs(payload);
      const docs = filterDocsToSelected(rawDocs, selectedIds);

      renderDocs(docs, selectedIds, payload);
    } catch (e) {
      elDbgJson.textContent = "JSON Parse Error:\n" + String(ev.data);
    }
  }

  es.addEventListener("update", handleUpdate);
  es.onmessage = handleUpdate;

})();
</script>
</body>
</html>
