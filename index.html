<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BewerbungsWerk – Vermieteransicht</title>

  <style>
    :root{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color-scheme: light;

      --bg: #f4f6fb;
      --card: #ffffff;
      --text: #0f172a;
      --muted: #64748b;

      --brandA: #1f6feb;
      --brandB: #00b894;

      --radius: 18px;
      --shadow: 0 14px 34px rgba(2,6,23,.08);
      --shadowSoft: 0 8px 20px rgba(2,6,23,.06);
      --border: rgba(15,23,42,.10);

      --okBg: #e8f7ee;
      --okFg: #0b6b2f;

      --badBg: #fdecec;
      --badFg: #8a1414;

      --warnBg: #fff7e6;
      --warnFg: #7a4b00;

      --chipBg: #eef2f6;
      --chipFg: #111827;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      background:
        radial-gradient(1200px 600px at 15% -10%, rgba(31,111,235,.14), transparent 60%),
        radial-gradient(900px 500px at 95% 0%, rgba(0,184,148,.12), transparent 55%),
        var(--bg);
      color: var(--text);
      padding: 18px;
    }
    .wrap{ max-width: 980px; margin: 0 auto; }

    .card{
      background: var(--card);
      border-radius: 22px;
      box-shadow: var(--shadow);
      border: 1px solid rgba(15,23,42,.06);
      padding: 22px;
      margin-bottom: 14px;
    }

    /* Header */
    .topbar{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 14px;
      flex-wrap: wrap;
    }

    .brand{
      display:flex;
      align-items:center;
      gap: 14px;
      min-width: 260px;
    }

    .logo{
      width: 54px;
      height: 54px;
      border-radius: 18px;
      background: linear-gradient(135deg, var(--brandA), var(--brandB));
      box-shadow: 0 14px 26px rgba(31,111,235,.18);
      display:grid;
      place-items:center;
      flex: 0 0 auto;
    }
    .logo svg{ width: 30px; height: 30px; color:#fff; }

    .brandTitle{
      margin:0;
      font-size: 42px;
      font-weight: 1000;
      letter-spacing: -0.045em;
      line-height: 1.02;
    }

    .brandSub{
      margin-top: 8px;
      color: var(--muted);
      font-size: 15px;
      font-weight: 750;
    }

    .rolePill{
      padding: 12px 18px;
      border-radius: 999px;
      font-weight: 950;
      border: 1px solid rgba(11,107,47,.18);
      background: linear-gradient(180deg, rgba(0,184,148,.18), rgba(0,184,148,.08));
      color: var(--okFg);
      white-space: nowrap;
      font-size: 16px;
    }

    /* Status container */
    .statusWrap{
      margin-top: 18px;
      padding: 18px;
      border-radius: 20px;
      border: 1px solid rgba(15,23,42,.08);
      background: linear-gradient(180deg, rgba(15,23,42,.02), rgba(255,255,255,.70));
      box-shadow: var(--shadowSoft);
    }

    .statusHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      flex-wrap: wrap;
    }

    .statusLeft{
      display:flex;
      align-items:center;
      gap: 12px;
      font-size: 22px;
      font-weight: 1000;
      letter-spacing: -0.02em;
    }

    .statusIcon{
      width: 44px;
      height: 44px;
      border-radius: 16px;
      display:grid;
      place-items:center;
      background: rgba(0,184,148,.12);
      border: 1px solid rgba(0,184,148,.22);
    }
    .statusIcon svg{ width: 22px; height: 22px; color: var(--okFg); }

    .badge{
      display:inline-flex;
      align-items:center;
      gap: 10px;
      padding: 10px 14px;
      border-radius: 999px;
      font-weight: 950;
      font-size: 14px;
      background: var(--chipBg);
      color: var(--chipFg);
      border: 1px solid rgba(15,23,42,.10);
      white-space: nowrap;
    }
    .ok{ background: var(--okBg); color: var(--okFg); border-color: rgba(11,107,47,.18); }
    .bad{ background: var(--badBg); color: var(--badFg); border-color: rgba(138,20,20,.18); }

    .statusLine{
      margin-top: 12px;
      display:flex;
      align-items:center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .statusText{
      color: var(--muted);
      font-weight: 800;
      font-size: 18px;
    }

    /* KPI chips like preview */
    .kpiRow{
      margin-top: 14px;
      display:flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .kpi{
      display:inline-flex;
      align-items:center;
      gap: 10px;
      padding: 12px 14px;
      border-radius: 16px;
      border: 1px solid rgba(15,23,42,.10);
      background: rgba(255,255,255,.85);
      box-shadow: 0 10px 18px rgba(2,6,23,.05);
      font-weight: 950;
      color: #111827;
      white-space: nowrap;
    }
    .kpi svg{ width: 20px; height: 20px; color: #334155; opacity:.9; }
    .kpi .muted{ color: var(--muted); font-weight: 850; }

    .warn{
      margin-top: 14px;
      background: var(--warnBg);
      color: var(--warnFg);
      padding: 12px 14px;
      border-radius: 16px;
      border: 1px solid rgba(122,75,0,.18);
      display:none;
      font-weight: 850;
    }

    /* Documents */
    .docsHeader{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 14px;
      flex-wrap: wrap;
    }

    .docsTitle{
      display:flex;
      align-items:center;
      gap: 12px;
      font-size: 28px;
      font-weight: 1000;
      letter-spacing: -0.03em;
      line-height: 1.1;
    }
    .docsTitle svg{ width: 26px; height: 26px; color: #2b6cb0; }

    .docsSub{
      margin-top: 6px;
      color: var(--muted);
      font-weight: 850;
      font-size: 18px;
    }

    .docsCount{
      padding: 12px 16px;
      border-radius: 999px;
      background: rgba(31,111,235,.10);
      border: 1px solid rgba(31,111,235,.18);
      color: #12458f;
      font-weight: 950;
      font-size: 16px;
      white-space: nowrap;
    }

    .list{
      margin-top: 16px;
      display:flex;
      flex-direction:column;
      gap: 14px;
    }

    .docRow{
      display:flex;
      gap: 14px;
      align-items:center;
      justify-content:space-between;
      border: 1px solid rgba(15,23,42,.10);
      border-radius: 18px;
      padding: 16px;
      background: #fff;
      box-shadow: var(--shadowSoft);
    }

    .docLeft{
      display:flex;
      gap: 14px;
      align-items:center;
      min-width: 0;
      flex: 1 1 auto;
    }

    /* Illustration tile (Preview-like) */
    .illus{
      width: 74px;
      height: 74px;
      border-radius: 18px;
      position: relative;
      flex: 0 0 auto;
      border: 1px solid rgba(15,23,42,.10);
      box-shadow: 0 14px 22px rgba(2,6,23,.06);
      overflow: hidden;
      background: linear-gradient(180deg, rgba(255,255,255,.6), rgba(255,255,255,.2));
    }

    .illusBg{
      position:absolute; inset:0;
      background: linear-gradient(180deg, var(--tintA), var(--tintB));
      opacity: 1;
    }

    .paper{
      position:absolute;
      left: 16px; top: 14px;
      width: 44px; height: 52px;
      border-radius: 12px;
      background: rgba(255,255,255,.78);
      border: 1px solid rgba(15,23,42,.10);
      box-shadow: 0 10px 18px rgba(2,6,23,.05);
    }
    .paper:before{
      content:"";
      position:absolute;
      right: 0; top: 0;
      width: 16px; height: 16px;
      background: rgba(15,23,42,.06);
      clip-path: polygon(0 0, 100% 0, 100% 100%);
      border-top-right-radius: 12px;
    }
    .lines{
      position:absolute;
      left: 22px; top: 26px;
      width: 32px; height: 22px;
      opacity: .85;
    }
    .lines div{
      height: 4px;
      border-radius: 999px;
      background: rgba(15,23,42,.16);
      margin-bottom: 5px;
    }
    .lines div:nth-child(2){ width: 26px; opacity: .85; }
    .lines div:nth-child(3){ width: 18px; opacity: .75; }

    .checkBadge{
      position:absolute;
      right: 10px; bottom: 10px;
      width: 26px; height: 26px;
      border-radius: 999px;
      display:grid;
      place-items:center;
      background: rgba(255,255,255,.9);
      border: 1px solid rgba(15,23,42,.12);
      box-shadow: 0 10px 18px rgba(2,6,23,.06);
    }
    .checkBadge svg{ width: 16px; height: 16px; color: var(--accent); }

    .docMain{ min-width: 0; }
    .docTitle{
      margin: 0;
      font-size: 22px;
      font-weight: 1000;
      letter-spacing: -0.03em;
      line-height: 1.12;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 520px;
    }
    .docType{
      margin-top: 6px;
      font-weight: 900;
      color: rgba(15,23,42,.70);
      font-size: 16px;
    }
    .docId{
      margin-top: 6px;
      color: var(--muted);
      font-size: 14px;
      font-weight: 750;
      word-break: break-word;
    }

    /* Soft Button with PDF chip (Preview-like) */
    .openBtn{
      display:inline-flex;
      align-items:center;
      gap: 12px;
      padding: 12px 16px;
      border-radius: 14px;
      border: 1px solid rgba(15,23,42,.12);
      background: rgba(255,255,255,.75);
      box-shadow: 0 10px 18px rgba(2,6,23,.05);
      color: #12458f;
      text-decoration:none;
      font-weight: 950;
      font-size: 16px;
      white-space: nowrap;
      transition: transform .15s ease, box-shadow .15s ease, background .15s ease;
    }
    .openBtn:hover{
      background: rgba(255,255,255,.92);
      box-shadow: 0 16px 26px rgba(2,6,23,.08);
      transform: translateY(-1px);
    }

    .pdfChip{
      width: 34px; height: 34px;
      border-radius: 10px;
      display:grid;
      place-items:center;
      background: linear-gradient(180deg, var(--accentSoft), rgba(255,255,255,.8));
      border: 1px solid rgba(15,23,42,.10);
      color: var(--accent);
      font-weight: 1000;
      font-size: 12px;
      letter-spacing: .02em;
    }

    .empty{
      padding: 16px;
      border-radius: 18px;
      border: 1px dashed rgba(15,23,42,.22);
      background: rgba(255,255,255,.75);
      color: var(--muted);
      font-weight: 850;
      line-height: 1.35;
      font-size: 16px;
    }

    /* Mobile */
    @media (max-width: 720px){
      body{ padding: 14px; }
      .card{ padding: 16px; }
      .brandTitle{ font-size: 34px; }
      .rolePill{ font-size: 15px; padding: 10px 14px; }

      .docRow{ flex-direction:column; align-items:stretch; }
      .openBtn{ width: 100%; justify-content:center; }
      .docTitle{ max-width: 100%; }
    }

    /* Debug */
    details summary{
      cursor:pointer;
      user-select:none;
      font-weight: 950;
      display:flex;
      align-items:center;
      gap: 8px;
    }
    details summary::-webkit-details-marker{ display:none; }

    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono";
      font-size: 12px;
    }
    .debugBox{
      white-space:pre-wrap;
      word-break:break-word;
      margin-top: 12px;
      background:#fafafa;
      border-radius: 14px;
      padding: 12px;
      border: 1px solid rgba(15,23,42,.08);
    }
  </style>
</head>

<body>
<div class="wrap">

  <!-- HEADER + STATUS -->
  <div class="card">
    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true">
          <svg viewBox="0 0 24 24" fill="none">
            <path d="M9 7V6a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v1" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <path d="M4 9h16v8a3 3 0 0 1-3 3H7a3 3 0 0 1-3-3V9Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
            <path d="M9 13h6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </div>
        <div>
          <div class="brandTitle">BewerbungsWerk</div>
          <div class="brandSub">Sicherer Zugriff auf freigegebene Mietunterlagen – live aktualisiert</div>
        </div>
      </div>
      <div class="rolePill">Vermieteransicht</div>
    </div>

    <div class="statusWrap">
      <div class="statusHeader">
        <div class="statusLeft">
          <div class="statusIcon" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none">
              <path d="M20 6 9 17l-5-5" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
          Status
        </div>
        <span id="conn" class="badge">Verbinden…</span>
      </div>

      <div class="statusLine">
        <span id="statusBadge" class="badge">Status: …</span>
        <span id="statusText" class="statusText">–</span>
      </div>

      <div class="kpiRow">
        <div class="kpi">
          <svg viewBox="0 0 24 24" fill="none"><path d="M2 12s3.5-7 10-7 10 7 10 7-3.5 7-10 7S2 12 2 12Z" stroke="currentColor" stroke-width="2"/><path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z" stroke="currentColor" stroke-width="2"/></svg>
          <span class="muted">Aufrufe</span> <span id="views">–</span>
        </div>
        <div class="kpi">
          <svg viewBox="0 0 24 24" fill="none"><path d="M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" stroke="currentColor" stroke-width="2"/><path d="M12 7v5l3 2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
          <span class="muted">Zuletzt angesehen</span> <span id="lastViewed">–</span>
        </div>
        <div class="kpi">
          <svg viewBox="0 0 24 24" fill="none"><path d="M20 6 9 17l-5-5" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/></svg>
          <span class="muted">Ausgewählt</span> <span id="selCount">–</span>
        </div>
      </div>

      <div id="warning" class="warn"></div>
    </div>
  </div>

  <!-- DOCUMENTS -->
  <div class="card">
    <div class="docsHeader">
      <div>
        <div class="docsTitle">
          <svg viewBox="0 0 24 24" fill="none">
            <path d="M4 7a2 2 0 0 1 2-2h5l2 2h7a2 2 0 0 1 2 2v8a3 3 0 0 1-3 3H7a3 3 0 0 1-3-3V7Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
          </svg>
          Freigegebene Dokumente
        </div>
        <div class="docsSub" id="docsHint">Warte auf Updates…</div>
      </div>

      <div class="docsCount" id="docsCount">– Dokumente freigegeben</div>
    </div>

    <div id="docs" class="list"></div>
  </div>

  <!-- DEBUG -->
  <div class="card">
    <details>
      <summary>Debug (optional)</summary>
      <div class="mono" id="dbgUrl" style="margin-top:10px; color: var(--muted);"></div>
      <pre class="mono debugBox" id="dbgJson"></pre>
    </details>
  </div>

</div>

<script>
(function () {
  const params = new URLSearchParams(window.location.search);
  const shareId = params.get("shareId");
  const token  = params.get("t");

  const elConn = document.getElementById("conn");
  const elStatusBadge = document.getElementById("statusBadge");
  const elStatusText = document.getElementById("statusText");
  const elViews = document.getElementById("views");
  const elLastViewed = document.getElementById("lastViewed");
  const elSelCount = document.getElementById("selCount");
  const elDocsHint = document.getElementById("docsHint");
  const elDocs = document.getElementById("docs");
  const elDocsCount = document.getElementById("docsCount");
  const elWarn = document.getElementById("warning");
  const elDbgUrl = document.getElementById("dbgUrl");
  const elDbgJson = document.getElementById("dbgJson");

  function esc(s) {
    return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }

  function setConn(text, ok) {
    elConn.textContent = text;
    elConn.className = "badge " + (ok ? "ok" : "bad");
  }

  function setStatus(ok, label, msg) {
    elStatusBadge.textContent = "Status: " + label;
    elStatusBadge.className = "badge " + (ok ? "ok" : "bad");
    elStatusText.textContent = msg || "";
  }

  function fmtDate(iso) {
    if (!iso) return "–";
    try { return new Date(iso).toLocaleString(); } catch (_) { return iso; }
  }

  function showWarn(text) {
    elWarn.style.display = text ? "block" : "none";
    elWarn.textContent = text || "";
  }

  function setDocsCount(n) {
    const num = Number(n || 0);
    elDocsCount.textContent = `${num} Dokument${num === 1 ? "" : "e"} freigegeben`;
  }

  if (!shareId || !token) {
    setConn("Fehler", false);
    setStatus(false, "BAD_REQUEST", "Fehlende Parameter (shareId / t).");
    showWarn("Die URL muss so aussehen: ?shareId=...&t=...");
    setDocsCount(0);
    elDocsHint.textContent = "Fehler: URL unvollständig";
    elDocs.innerHTML = `<div class="empty">Fehlende Parameter in der URL: <span class="mono">shareId</span> und <span class="mono">t</span>.</div>`;
    if (elDbgUrl) elDbgUrl.textContent = "";
    if (elDbgJson) elDbgJson.textContent = "";
    return;
  }

  // stable viewer id
  const key = "bm_viewer_id";
  let viewerId = localStorage.getItem(key);
  if (!viewerId) {
    viewerId = (crypto.randomUUID ? crypto.randomUUID() : (Date.now() + "_" + Math.random()));
    localStorage.setItem(key, viewerId);
  }

  const FUNCTIONS_BASE = "https://cylqwswkekqwfefqmgya.functions.supabase.co";
  const streamUrl =
    FUNCTIONS_BASE + "/share_stream" +
    "?shareId=" + encodeURIComponent(shareId) +
    "&t=" + encodeURIComponent(token) +
    "&v=" + encodeURIComponent(viewerId);

  if (elDbgUrl) elDbgUrl.textContent = streamUrl;

  function buildDownloadUrl(docId) {
    return (
      FUNCTIONS_BASE +
      "/download" +
      "?shareId=" + encodeURIComponent(shareId) +
      "&t=" + encodeURIComponent(token) +
      "&docId=" + encodeURIComponent(docId)
    );
  }

  function extractDocs(payload) {
    if (Array.isArray(payload)) return payload;
    if (payload && Array.isArray(payload.documents)) return payload.documents;
    if (payload && Array.isArray(payload.docs)) return payload.docs;
    return [];
  }

  function extractSelectedIds(payload) {
    if (!payload) return [];
    const eff = payload.effectiveSelectedIds;
    const sel = payload.selectedIds;
    if (Array.isArray(eff)) return eff.filter(Boolean);
    if (Array.isArray(sel)) return sel.filter(Boolean);
    return [];
  }

  function filterDocsToSelected(docs, selectedIds) {
    if (!Array.isArray(docs)) return [];
    if (!Array.isArray(selectedIds) || selectedIds.length === 0) return [];
    const set = new Set(selectedIds);
    return docs.filter(d => d && d.id && set.has(d.id) && !d.missing);
  }

  function themeForType(type) {
    const t = String(type || "").toLowerCase();

    // SCHUFA (blue)
    if (t.includes("schufa") || t.includes("bon")) {
      return {
        tintA: "rgba(129,200,255,.55)",
        tintB: "rgba(207,233,255,.50)",
        accent: "#2b6cb0",
        accentSoft: "rgba(43,108,176,.18)",
        pretty: "SCHUFA-Auskunft",
        subtitle: "Bonitätsnachweis",
      };
    }

    // Income (green)
    if (t.includes("income") || t.includes("gehalt") || t.includes("salary") || t.includes("lohn")) {
      return {
        tintA: "rgba(153,230,192,.55)",
        tintB: "rgba(220,246,235,.50)",
        accent: "#0b6b2f",
        accentSoft: "rgba(11,107,47,.16)",
        pretty: "Gehaltsnachweis",
        subtitle: "Einkommensnachweis",
      };
    }

    // ID (beige)
    if (t.includes("ausweis") || t.includes("id") || t.includes("ident")) {
      return {
        tintA: "rgba(245,220,170,.55)",
        tintB: "rgba(252,244,228,.55)",
        accent: "#8a6d3b",
        accentSoft: "rgba(138,109,59,.16)",
        pretty: "Personalausweis",
        subtitle: "Identitätsnachweis",
      };
    }

    // Default (neutral)
    return {
      tintA: "rgba(210,222,238,.55)",
      tintB: "rgba(244,247,252,.55)",
      accent: "#334155",
      accentSoft: "rgba(51,65,85,.14)",
      pretty: "Dokument",
      subtitle: "Unterlage",
    };
  }

  function renderDocs(docs, selectedIds, payload) {
    const count = Array.isArray(selectedIds) ? selectedIds.length : 0;
    elSelCount.textContent = String(count);
    setDocsCount(count);

    if (payload && payload.missing) {
      showWarn("Hinweis: Einige Dokumente sind nicht mehr verfügbar und werden ausgeblendet.");
    } else {
      showWarn("");
    }

    if (!Array.isArray(selectedIds) || selectedIds.length === 0) {
      elDocsHint.textContent = "Der Bewerber hat aktuell keine Dokumente freigegeben.";
      elDocs.innerHTML = `<div class="empty">Der Bewerber hat aktuell keine Dokumente freigegeben. Sobald Dokumente freigegeben werden, erscheint die Liste automatisch.</div>`;
      return;
    }

    if (!Array.isArray(docs) || docs.length === 0) {
      elDocsHint.textContent = "Auswahl ist leer (Dokumente fehlen oder wurden entfernt).";
      elDocs.innerHTML = `<div class="empty">Die freigegebenen Dokumente sind gerade nicht verfügbar. Bitte warten Sie kurz oder laden Sie die Seite neu.</div>`;
      return;
    }

    elDocsHint.textContent = "Klicken Sie auf „Dokument öffnen“, um ein freigegebenes Dokument anzusehen.";
    elDocs.innerHTML = "";

    for (const d of docs) {
      const title = (d && (d.title ?? d.name)) || "(ohne Titel)";
      const type  = (d && (d.type  ?? d.mime)) || "";
      const openUrl = buildDownloadUrl(d.id);

      const th = themeForType(type);

      const row = document.createElement("div");
      row.className = "docRow";
      row.style.setProperty("--tintA", th.tintA);
      row.style.setProperty("--tintB", th.tintB);
      row.style.setProperty("--accent", th.accent);
      row.style.setProperty("--accentSoft", th.accentSoft);

      row.innerHTML = `
        <div class="docLeft">
          <div class="illus" aria-hidden="true">
            <div class="illusBg"></div>
            <div class="paper"></div>
            <div class="lines">
              <div></div><div></div><div></div>
            </div>
            <div class="checkBadge">
              <svg viewBox="0 0 24 24" fill="none">
                <path d="M20 6 9 17l-5-5" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </div>
          </div>

          <div class="docMain">
            <div class="docTitle">${esc(title)}</div>
            <div class="docType">${esc(th.pretty)}</div>
            <div class="docId mono">${esc(d.id)}</div>
          </div>
        </div>

        <a class="openBtn" href="${esc(openUrl)}" target="_blank" rel="noopener">
          <span class="pdfChip">PDF</span>
          Dokument öffnen
        </a>
      `;

      elDocs.appendChild(row);
    }
  }

  function handleUpdate(ev) {
    try {
      const payload = JSON.parse(ev.data);
      if (elDbgJson) elDbgJson.textContent = JSON.stringify(payload, null, 2);

      const selectedIds = extractSelectedIds(payload);
      const rawDocs = extractDocs(payload);
      const docs = filterDocsToSelected(rawDocs, selectedIds);

      renderDocs(docs, selectedIds, payload);
    } catch (e) {
      if (elDbgJson) elDbgJson.textContent = "JSON Parse Error:\n" + String(ev.data);
    }
  }

  // Init UI
  setConn("Verbinden…", true);
  setStatus(true, "…", "Warte auf Status…");
  setDocsCount(0);

  // SSE
  const es = new EventSource(streamUrl);

  es.addEventListener("open", () => setConn("Live verbunden", true));
  es.addEventListener("error", () => setConn("Reconnecting…", false));

  es.addEventListener("status", (ev) => {
    try{
      const data = JSON.parse(ev.data);
      if (data.ok) {
        setStatus(true, "Freigabe aktiv", "Live-Ansicht ist aktiv.");
        if (typeof data.view_count !== "undefined") elViews.textContent = String(data.view_count);
        if (data.last_viewed_at) elLastViewed.textContent = fmtDate(data.last_viewed_at);
      } else {
        setStatus(false, data.code || "INAKTIV", data.message || "");
      }
    }catch(_){}
  });

  es.addEventListener("update", handleUpdate);
  es.onmessage = handleUpdate;

})();
</script>
</body>
</html>
