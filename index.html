<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bewerbungsmappe – Viewer</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    body { margin:0; background:#f6f7f9; color:#111; padding:20px; }
    .wrap { max-width: 900px; margin: 0 auto; }
    .card { background:#fff; border-radius:14px; padding:18px; box-shadow: 0 6px 24px rgba(0,0,0,.06); margin-bottom:14px; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between; }
    .title { margin:0; font-size:20px; font-weight:800; }
    .badge { display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; font-weight:800; font-size:13px; background:#eee; }
    .ok { background:#e8f7ee; color:#0b6b2f; }
    .bad { background:#fdecec; color:#8a1414; }
    .muted { color:#666; }
    .kv { display:flex; gap:18px; flex-wrap:wrap; margin-top:10px; }
    .kv > div { min-width: 180px; }
    .label { font-size:12px; color:#666; margin-bottom:4px; }
    .value { font-size:14px; font-weight:700; }
    ul { margin:10px 0 0; padding-left:18px; }
    li { margin-bottom:10px; }
    .doc-title { font-weight:800; }
    .pill { display:inline-block; margin-left:8px; padding:2px 8px; border-radius:999px; background:#f0f0f0; font-size:12px; font-weight:800; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono"; font-size:12px; }
    .warn { background:#fff7e6; color:#7a4b00; padding:10px 12px; border-radius:12px; }
    a { font-weight: 800; }
  </style>
</head>
<body>
<div class="wrap">

  <div class="card">
    <div class="row">
      <h1 class="title">Bewerbungsmappe</h1>
      <span id="conn" class="badge">Verbinden…</span>
    </div>

    <div class="row" style="justify-content:flex-start; margin-top:10px;">
      <span id="statusBadge" class="badge">Status: …</span>
      <span id="statusText" class="muted">–</span>
    </div>

    <div class="kv">
      <div>
        <div class="label">Aufrufe</div>
        <div class="value" id="views">–</div>
      </div>
      <div>
        <div class="label">Zuletzt angesehen</div>
        <div class="value" id="lastViewed">–</div>
      </div>
      <div>
        <div class="label">Ausgewählt</div>
        <div class="value" id="selCount">–</div>
      </div>
    </div>

    <div id="warning" class="warn" style="display:none; margin-top:12px;"></div>
  </div>

  <div class="card">
    <div class="row" style="justify-content:flex-start;">
      <div style="font-size:16px;font-weight:900;">Dokumente</div>
      <div class="muted" id="docsHint">Warte auf Updates…</div>
    </div>
    <ul id="docs"></ul>
  </div>

  <div class="card">
    <div class="row" style="justify-content:flex-start;">
      <div style="font-size:16px;font-weight:900;">Debug (optional)</div>
      <div class="muted mono" id="dbgUrl"></div>
    </div>
    <pre class="mono" id="dbgJson" style="white-space:pre-wrap; word-break:break-word; margin:10px 0 0; background:#fafafa; border-radius:12px; padding:12px;"></pre>
  </div>

</div>

<script>
(function () {
  const params = new URLSearchParams(window.location.search);
  const shareId = params.get("shareId");
  const token  = params.get("t");

  const elConn = document.getElementById("conn");
  const elStatusBadge = document.getElementById("statusBadge");
  const elStatusText = document.getElementById("statusText");
  const elViews = document.getElementById("views");
  const elLastViewed = document.getElementById("lastViewed");
  const elSelCount = document.getElementById("selCount");
  const elDocsHint = document.getElementById("docsHint");
  const elDocs = document.getElementById("docs");
  const elWarn = document.getElementById("warning");
  const elDbgUrl = document.getElementById("dbgUrl");
  const elDbgJson = document.getElementById("dbgJson");

  function setConn(text, ok) {
    elConn.textContent = text;
    elConn.className = "badge " + (ok ? "ok" : "bad");
  }
  function setStatus(ok, label, msg) {
    elStatusBadge.textContent = "Status: " + label;
    elStatusBadge.className = "badge " + (ok ? "ok" : "bad");
    elStatusText.textContent = msg || "";
  }
  function fmtDate(iso) {
    if (!iso) return "–";
    try { return new Date(iso).toLocaleString(); } catch (_) { return iso; }
  }
  function esc(s) {
    return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }
  function showWarn(text) {
    elWarn.style.display = text ? "block" : "none";
    elWarn.textContent = text || "";
  }

  if (!shareId || !token) {
    setConn("Fehler", false);
    setStatus(false, "BAD_REQUEST", "Fehlende Parameter (shareId / t).");
    showWarn("Die URL muss so aussehen: ?shareId=...&t=...");
    return;
  }

  // stable viewer id
  const key = "bm_viewer_id";
  let viewerId = localStorage.getItem(key);
  if (!viewerId) {
    viewerId = (crypto.randomUUID ? crypto.randomUUID() : (Date.now() + "_" + Math.random()));
    localStorage.setItem(key, viewerId);
  }

  const FUNCTIONS_BASE = "https://cylqwswkekqwfefqmgya.functions.supabase.co";

  function buildDownloadUrl(docId) {
    return (
      FUNCTIONS_BASE +
      "/download" +
      "?shareId=" + encodeURIComponent(shareId) +
      "&t=" + encodeURIComponent(token) +
      "&docId=" + encodeURIComponent(docId)
    );
  }

  // ✅ Stream URL
  const streamUrl =
    FUNCTIONS_BASE + "/share_stream" +
    "?shareId=" + encodeURIComponent(shareId) +
    "&t=" + encodeURIComponent(token) +
    "&v=" + encodeURIComponent(viewerId);

  elDbgUrl.textContent = streamUrl;

  setConn("Verbinden…", true);
  setStatus(true, "…", "Warte auf Status…");

  const es = new EventSource(streamUrl);

  es.addEventListener("open", () => {
    setConn("Live verbunden", true);
    showWarn("");
  });

  es.addEventListener("error", () => {
    setConn("Verbindung verloren (reconnect…)", false);
    showWarn("Die Verbindung zum Live-Stream ist unterbrochen. Der Browser versucht automatisch neu zu verbinden.");
  });

  es.addEventListener("status", (ev) => {
    try {
      const data = JSON.parse(ev.data);

      if (data.ok) {
        setStatus(true, "Aktiv", "Live-Ansicht ist aktiv.");
        if (typeof data.view_count !== "undefined") elViews.textContent = String(data.view_count);
        if (data.last_viewed_at) elLastViewed.textContent = fmtDate(data.last_viewed_at);
        if (data.warning) showWarn(String(data.warning));
      } else {
        setStatus(false, data.code || "INAKTIV", data.message || "");
        if (typeof data.view_count !== "undefined") elViews.textContent = String(data.view_count);
        if (data.last_viewed_at) elLastViewed.textContent = fmtDate(data.last_viewed_at);
      }
    } catch (_) {}
  });

  // ✅ Robust: akzeptiert data.documents, data.docs oder direkt Array
  function extractDocs(payload) {
    if (Array.isArray(payload)) return payload;
    if (payload && Array.isArray(payload.documents)) return payload.documents;
    if (payload && Array.isArray(payload.docs)) return payload.docs;
    if (payload && payload.data && Array.isArray(payload.data.documents)) return payload.data.documents;
    if (payload && payload.data && Array.isArray(payload.data.docs)) return payload.data.docs;
    return [];
  }

  // ✅ NEU: effectiveSelectedIds bevorzugen
  function extractSelectedIds(payload) {
    if (!payload) return [];
    const eff = payload.effectiveSelectedIds;
    const sel = payload.selectedIds;

    if (Array.isArray(eff)) return eff.filter(Boolean);
    if (Array.isArray(sel)) return sel.filter(Boolean);
    return [];
  }

  // ✅ NEU: filtert docs auf die IDs, die wirklich ausgewählt sind
  function filterDocsToSelected(docs, selectedIds) {
    if (!Array.isArray(docs)) return [];
    if (!Array.isArray(selectedIds) || selectedIds.length === 0) return [];
    const set = new Set(selectedIds);
    return docs.filter(d => d && d.id && set.has(d.id) && !d.missing);
  }

  function renderDocs(docs, selectedIds, payload) {
  elSelCount.textContent = String(Array.isArray(selectedIds) ? selectedIds.length : 0);
  elDocs.innerHTML = "";

  if (payload && payload.missing) {
    const ids = Array.isArray(payload.missingIds) ? payload.missingIds : [];
    showWarn(`Einige Dokumente sind nicht mehr verfügbar (${ids.length}).`);
  } else {
    showWarn("");
  }

  if (!Array.isArray(selectedIds) || selectedIds.length === 0) {
    elDocsHint.textContent = "Keine Dokumente ausgewählt.";
    elDocs.innerHTML = "<li class='muted'>Keine Dokumente ausgewählt.</li>";
    return;
  }

  elDocsHint.textContent = "Freigegebene Dokumente:";

  docs.forEach((d) => {
    const li = document.createElement("li");
    li.style.listStyle = "none";
    li.style.marginBottom = "14px";

    const title = (d && (d.title ?? d.name)) || "(ohne Titel)";
    const type  = (d && (d.type  ?? d.mime)) || "(ohne Typ)";
    const openUrl = buildDownloadUrl(d.id);

    li.innerHTML = `
      <div style="
        background:#ffffff;
        border-radius:16px;
        padding:16px;
        box-shadow:0 6px 18px rgba(0,0,0,0.06);
        transition:all .2s ease;
      "
      onmouseover="this.style.transform='translateY(-2px)'"
      onmouseout="this.style.transform='translateY(0)'"
      >
        <div style="font-size:16px;font-weight:900;margin-bottom:4px;">
          ${esc(title)}
        </div>
        <div style="font-size:13px;color:#666;margin-bottom:8px;">
          ${esc(type)}
        </div>
        <a href="${esc(openUrl)}"
           target="_blank"
           rel="noopener"
           style="
             display:inline-block;
             padding:8px 14px;
             border-radius:999px;
             background:#111;
             color:#fff;
             text-decoration:none;
             font-size:13px;
             font-weight:700;
           ">
           Dokument öffnen
        </a>
      </div>
    `;

    elDocs.appendChild(li);
  });
}

  function handleUpdate(ev) {
    try {
      const payload = JSON.parse(ev.data);
      elDbgJson.textContent = JSON.stringify(payload, null, 2);

      // 1) IDs bevorzugt aus effectiveSelectedIds holen
      const selectedIds = extractSelectedIds(payload);

      // 2) docs ziehen
      const rawDocs = extractDocs(payload);

      // 3) docs auf selectedIds filtern (und missing ausblenden)
      const docs = filterDocsToSelected(rawDocs, selectedIds);

      renderDocs(docs, selectedIds, payload);
    } catch (e) {
      elDbgJson.textContent = "JSON Parse Error:\n" + String(ev.data);
    }
  }

  es.addEventListener("update", handleUpdate);
  es.onmessage = handleUpdate;

})();
</script>
</body>
</html>
